#include "timer_utils.h"

XTmrCtr TimerInstance;
volatile int flag_read_opt = 0;

// Callback de alto nivel llamado por el driver del timer
void Timer_Callback(void *CallBackRef, u8 TmrNum)
{
    (void)CallBackRef;
    (void)TmrNum;

    flag_read_opt = 1;
}

int timer_init_1s(void)
{
    int status;

    // Inicializar AXI Timer 0
    status = XTmrCtr_Initialize(&TimerInstance, TIMER_DEVICE_ID);
    if (status != XST_SUCCESS)
        return XST_FAILURE;

    // Registrar callback de usuario
    XTmrCtr_SetHandler(&TimerInstance, Timer_Callback, &TimerInstance);

    // Timer 0: interrupciones + autoreload + down-count
    XTmrCtr_SetOptions(&TimerInstance, 0,
                       XTC_INT_MODE_OPTION |
                       XTC_AUTO_RELOAD_OPTION |
                       XTC_DOWN_COUNT_OPTION);

    // Como estamos en down-count, cargamos directamente 1 segundo de cuentas:
    // con 100 MHz -> 100_000_000 cuentas.
    XTmrCtr_SetResetValue(&TimerInstance, 0, TIMER_CLOCK_FREQ);

    // Arrancar Timer 0
    XTmrCtr_Start(&TimerInstance, 0);

    return XST_SUCCESS;
}
