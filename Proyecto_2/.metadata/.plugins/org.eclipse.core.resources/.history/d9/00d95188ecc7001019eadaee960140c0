#include "maze_game.h"
#include <stdio.h>

void Maze_InitLevel1(GameState *game)
{
    Maze *m = &game->maze;
    Player *p = &game->player;

    m->rows = 8;
    m->cols = 10;

    // Llenar con muros
    for (int r = 0; r < m->rows; r++) {
        for (int c = 0; c < m->cols; c++) {
            m->cells[r][c] = CELL_WALL;
        }
    }

    // Camino horizontal (Fila 0)
    for (int c = 0; c < m->cols; c++) m->cells[0][c] = CELL_PATH;

    // Camino vertical (Última columna)
    for (int r = 1; r < m->rows; r++) m->cells[r][m->cols - 1] = CELL_PATH;

    // Salida
    m->exitRow = 7;
    m->exitCol = 9;
    m->cells[m->exitRow][m->exitCol] = CELL_EXIT;

    // Trampa y camino lateral
    m->cells[1][4] = CELL_PATH;
    m->cells[1][3] = CELL_PATH;
    m->cells[1][2] = CELL_TRAP;

    // Inicio
    m->startRow = 0;
    m->startCol = 0;

    // Jugador
    p->row   = m->startRow;
    p->col   = m->startCol;
    p->lives = 3;
    p->score = 0;

    game->state = GAME_RUNNING;
}

int Game_TryMove(GameState *game, char dir)
{
    if (game->state != GAME_RUNNING) return MOVE_INVALID;

    Maze   *m = &game->maze;
    Player *p = &game->player;

    int newRow = p->row;
    int newCol = p->col;

    switch (dir) {
    case 'u': case 'U': newRow--; break;
    case 'd': case 'D': newRow++; break;
    case 'l': case 'L': newCol--; break;
    case 'r': case 'R': newCol++; break;
    default: return MOVE_INVALID;
    }

    // Límites
    if (newRow < 0 || newRow >= m->rows || newCol < 0 || newCol >= m->cols)
        return MOVE_INVALID;

    int cell = m->cells[newRow][newCol];

    // Muro
    if (cell == CELL_WALL) return MOVE_INVALID;

    // Mover
    p->row = newRow;
    p->col = newCol;

    if (cell == CELL_TRAP) {
        p->lives--;
        if (p->lives <= 0) {
            game->state = GAME_LOSE;
        } else {
            p->row = m->startRow; // Reset posición
            p->col = m->startCol;
        }
        return MOVE_TRAP;
    }

    if (cell == CELL_EXIT) {
        game->state = GAME_WIN;
        p->score += 100;
        return MOVE_EXIT;
    }

    p->score++;
    return MOVE_OK;
}

int Game_HasFinished(const GameState *game)
{
    return game->state;
}
