#include "Joystick.h"
#include "ADC.h"
#include "Delay.h"

// Canales (Deben coincidir con hardware real)
#define ADC_CH_JOY_X  2
#define ADC_CH_JOY_Y  10

void Joystick_init(Joystick *js)
{
    js->center_x = 2048;
    js->center_y = 2048;
    js->deadzone = 0.15f;
    js->max_range = 2048.0f;
}

void Joystick_calibrate(Joystick *js, int samples)
{
    long sum_x = 0;
    long sum_y = 0;
    for(int i = 0; i < samples; i++) {
        sum_x += read_adc(ADC_CH_JOY_X);
        sum_y += read_adc(ADC_CH_JOY_Y);
        delay_ms(10);
    }
    js->center_x = (int)(sum_x / samples);
    js->center_y = (int)(sum_y / samples);
}

void Joystick_read_raw(int *jx, int *jy)
{
    *jx = read_adc(ADC_CH_JOY_X);
    *jy = read_adc(ADC_CH_JOY_Y);
}

void Joystick_read_normalized(Joystick *js, float *nx, float *ny)
{
    int raw_x, raw_y;
    float dx, dy;

    Joystick_read_raw(&raw_x, &raw_y);

    dx = (float)(raw_x - js->center_x);
    dy = (float)(raw_y - js->center_y);

    *nx = dx / js->max_range;
    *ny = dy / js->max_range;

    if ((*nx * *nx + *ny * *ny) < (js->deadzone * js->deadzone)) {
        *nx = 0.0f;
        *ny = 0.0f;
    }
}
