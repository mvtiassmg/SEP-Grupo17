#include "I2C.h"

#include "xil_printf.h"
#include "xiic.h"

// Definiciones de direcciones de los sensores (Según tu código y datasheet)
#define TMP_ADDR            0x40
#define OPT_ADDR            0x44
#define OPT_REG_CONFIG      0x01
#define TMP_REG_CONFIG      0x02

// Definiciones de la instancia IIC (asumimos que ya existen en otro lugar)
extern XIic iic;
extern u8 SendBuffer[2];
extern u8 RecvBuffer[2];
extern u16 Lux;
extern int16_t val;
extern int temp;

int init_IIC()
{
    XIic_Config *iic_conf;
    int Status;

    // 1. Inicialización del Driver AXI IIC
    iic_conf = XIic_LookupConfig(XPAR_AXI_IIC_0_DEVICE_ID); // Usamos ID de xparameters.h
    if (iic_conf == NULL) {
        xil_printf("I2C: Error LookupConfig\r\n");
        return XST_DEVICE_NOT_FOUND;
    }

    Status = XIic_CfgInitialize(&iic, iic_conf, iic_conf->BaseAddress);
    if (Status != XST_SUCCESS) return XST_FAILURE;


    XIic_Start(&iic);

    // --- CONFIGURACIÓN DEL SENSOR DE LUZ (OPT3001) ---
    // Valor: 0xC410 (Auto-Range, 100ms, Continuo)
    u8 opt_config_cmd[3];
    opt_config_cmd[0] = OPT_REG_CONFIG; // Puntero al registro de Configuración (0x01)
    opt_config_cmd[1] = 0xC4;           // MSB: 1100 (Auto-Range) 010 (800ms) - (0x0C410 es 800ms)
    opt_config_cmd[2] = 0x10;           // LSB

    // Enviar los 3 bytes (Registro + 2 bytes de datos)
    Status = XIic_Send(iic.BaseAddress, OPT_ADDR, opt_config_cmd, 3, XIIC_STOP);

    if (Status != 3) {
        xil_printf("I2C: OPT3001 Config Fallo! Status: %d\r\n", Status);
        // Si falla aquí, la comunicación está rota, pero continuamos si no es crítico
        return XST_FAILURE;
    }

    // --- CONFIGURACIÓN DEL SENSOR DE TEMPERATURA (TMP006) ---
    // Valor: 0x7400 (Continuous, 1 conv/sec)
    u8 tmp_config[3];
    tmp_config[0] = TMP_REG_CONFIG; // Puntero al registro de Configuración (0x02)
    tmp_config[1] = 0x74;           // MSB: MOD=111, CR=010 (1s)
    tmp_config[2] = 0x00;           // LSB

    Status = XIic_Send(iic.BaseAddress, TMP_ADDR, tmp_config, 3, XIIC_STOP);

    if (Status != 3) {
        xil_printf("I2C: TMP006 Config Fallo! Status: %d\r\n", Status);
        return XST_FAILURE;
    }

    return XST_SUCCESS;
}

int read_tmp()
{
    u8 reg_temp = 0x01; // Registro de temperatura ambiente

    XIic_Send(iic.BaseAddress, TMP_ADDR, &reg_temp, 1, XIIC_REPEATED_START);
    XIic_Recv(iic.BaseAddress, TMP_ADDR, RecvBuffer, 2, XIIC_STOP);

    val = (RecvBuffer[0] << 8) | RecvBuffer[1];
    val = val >> 2; // Ajuste de 14 bits
    temp = val / 32; // Conversión a Celsius

    return temp;
}

int read_opt()
{
    u8 config_cmd[3];
    config_cmd[0] = 0x01;
    config_cmd[1] = 0xC4;
    config_cmd[2] = 0x10;

    XIic_Send(iic.BaseAddress, OPT_ADDR, config_cmd, 3, XIIC_STOP);

    u8 reg_result = 0x00;
    XIic_Send(iic.BaseAddress, OPT_ADDR, &reg_result, 1, XIIC_REPEATED_START);
    XIic_Recv(iic.BaseAddress, OPT_ADDR, RecvBuffer, 2, XIIC_STOP);

    u16 raw = (RecvBuffer[0] << 8) | RecvBuffer[1];
    u16 exponent = (raw >> 12) & 0x0F;
    u16 mantissa = raw & 0x0FFF;

    u32 lux_val = mantissa * (1 << exponent);
    Lux = (u16)(lux_val / 100);

    return (int)Lux;
}
